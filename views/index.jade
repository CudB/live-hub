extend layout

block content
  //- iframe(src="https://www-cdn.jtvnw.net/swflibs/TwitchPlayer.rd6a0d073735dbb05d88bcf4fd798b5e148f4e8f9.swf?channel=riotgame", frameborder="0", scrolling="no", height="378", width="620")
  div(id="player")
  //- iframe(width="560", height="315", src="https://www.youtube.com/embed/videoseries?list=PLFgquLnL59alZ5m7XEk44TI-FTrfNwL2B", frameborder="0", allowfullscreen)
  //- .votebuttons
  p 
    button(id="likeBtn", class="likeBtn") LIKE
    button(id="skipBtn", class="skipBtn") VOTE TO SKIP
block sidebar
  .outputwidget
    .outputbox
      ul(id = "messages")
  .inputwidget  
    .inputbox
      input.formcontrol(type = "text", id= "nameInput", placeholder = "Name", maxlength = 20)
      input.formcontrol(type = "text", id= "messageInput" placeholder = "Message", maxlength = 50)

block scripts
  script(src='https://cdn.firebase.com/js/client/2.2.1/firebase.js')
  script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js')
  script(src='https://apis.google.com/js/client.js?onload=function')
  script.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '315',
        width: '560',
        playerVars: {
          listType: 'playlist',
          list: 'PLFgquLnL59alZ5m7XEk44TI-FTrfNwL2B',
          controls: 0,
          showinfo: 0
        },
        events: {
          //- 'onReady': onPlayerReady,
          //- 'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
        event.target.playVideo();
    }

    var done = false;
    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.PLAYING && !done) {
        setTimeout(stopVideo, 6000);
        done = true;
      }
    }
    function stopVideo() {
      player.stopVideo();
    }

  script.
    var fb = new Firebase('https://flickering-inferno-2389.firebaseio.com/');

    var messageField = $('#messageInput');
    var nameField = $('#nameInput');
    var messageList = $('#messages');

    var skipSelected = 0;
    var skipCounterOld;

    fb.child('skipCounter').on("value", function(snapshot) {
      console.log(snapshot.val());
      if(snapshot.val() >= 2) {
        fb.child('skipCounter').transaction(function(currentValue) {
          return 0;
        });   
        resetButtons();
      }
      if(skipCounterOld > 0 && snapshot.val() == 0) {
        player.nextVideo();
        resetButtons();
      }
      skipCounterOld = snapshot.val();
    });

    messageField.keypress(function (e) {
      if (e.keyCode == 13) {
        //FIELD VALUES
        var username = nameField.val();
        var message = messageField.val();

        //SAVE DATA TO FIREBASE AND EMPTY FIELD
        fb.child('messages').push({name:username, text:message});
        messageField.val('');
      }
    });

    // Add a callback that is triggered for each chat message.
    fb.child('messages').limitToLast(10).on('child_added', function (snapshot) {
      //GET DATA
      var data = snapshot.val();
      var username = data.name || "anonymous";
      var message = data.text;

      //CREATE ELEMENTS MESSAGE & SANITIZE TEXT
      var messageElement = $("<li>");
      var nameElement = $("<strong class='example-chat-username'></strong>")
      nameElement.text(username);
      messageElement.text(message).prepend(nameElement.append(": "));

      //ADD MESSAGE
      messageList.append(messageElement)

      //SCROLL TO BOTTOM OF MESSAGE LIST
      messageList.scrollTop(messageList[0].scrollHeight);
    });
    
    var likeBtn = $('#likeBtn');
    var skipBtn = $('#skipBtn');
    
    likeBtn.click(function() {
        $(this).prop('disabled', true);
        $(this).attr('class', 'btnSelected');
        skipBtn.prop('disabled', false);
        skipBtn.attr('class', 'skipBtn');
        if(skipSelected) {
          decSkip();
          skipSelected = 0;
        }
        
    });
    
    skipBtn.click(function() {
        $(this).prop('disabled', true);
        $(this).attr('class', 'btnSelected');
        likeBtn.prop('disabled', false);
        likeBtn.attr('class', 'likeBtn');
        incSkip();
        skipSelected = 1;
    });

    function resetButtons() {
      likeBtn.prop('disabled', false);
      likeBtn.attr('class', 'likeBtn');
      skipBtn.prop('disabled', false);
      skipBtn.attr('class', 'skipBtn');
      skipSelected = 0;
    }

    function incSkip() {
      // increment the counter
      fb.child('skipCounter').transaction(function(currentValue) {
          return (currentValue||0) + 1
      });
    }

    function decSkip() {
      // increment the counter
      fb.child('skipCounter').transaction(function(currentValue) {
          return (currentValue||0) - 1
      });
    }
